!function(e){"use strict";function a(){return"ondrag"in document.createElement("a")}function n(e){"undefined"!=typeof e.dataTransfer&&"none"===e.dataTransfer.dropEffect&&("copy"===e.dataTransfer.effectAllowed||"move"===e.dataTransfer.effectAllowed?e.dataTransfer.dropEffect=e.dataTransfer.effectAllowed:("copyMove"===e.dataTransfer.effectAllowed||"copymove"===e.dataTransfer.effectAllowed)&&(e.dataTransfer.dropEffect=e.ctrlKey?"copy":"move"))}if(!a())return void e.module("ang-drag-drop",[]);window.jQuery&&-1===window.jQuery.event.props.indexOf("dataTransfer")&&window.jQuery.event.props.push("dataTransfer");var t=e.module("ang-drag-drop",[]);t.directive("uiDraggable",["$parse","$rootScope","$dragImage",function(a,t,r){return function(o,d,f){function i(e){setTimeout(function(){d.unbind("$destroy",i)},0);var r=f.dragChannel||"defaultchannel";if(t.$broadcast("ANGULAR_DRAG_END",e,r),n(e),e.dataTransfer&&"none"!==e.dataTransfer.dropEffect)if(f.onDropSuccess){var s=a(f.onDropSuccess);o.$evalAsync(function(){s(o,{$event:e})})}else if(f.onDropFailure){var l=a(f.onDropFailure);o.$evalAsync(function(){l(o,{$event:e})})}d.removeClass(v)}function s(n,t){var r;n&&n.dataTransfer&&n.dataTransfer.setDragImage&&(r=a(t),o.$apply(function(){var a,t=r(o,{$event:n});t&&e.isString(t)&&(a=document.getElementById(t),a&&n.dataTransfer.setDragImage(a,0,0))}))}function l(n){var l=!c||u.classList.contains(g);if(l){var p=f.dragChannel||"defaultchannel",$="";f.drag&&($=o.$eval(f.drag));var m=f.dragImage||null;d.addClass(v),d.bind("$destroy",i);var h=!(document.uniqueID||window.opera);if(m&&h){var y=a(f.dragImage);o.$apply(function(){var a=y(o,{$event:n});if(a&&(e.isString(a)&&(a=r.generate(a)),a.image)){var t=a.xOffset||0,d=a.yOffset||0;n.dataTransfer.setDragImage(a.image,t,d)}})}else f.dragImageElementId&&s(n,f.dragImageElementId);var D={x:n.originalEvent.offsetX,y:n.originalEvent.offsetY},b={data:$,channel:p,offset:D},A=e.toJson(b);n.dataTransfer.setData("text",A),n.dataTransfer.effectAllowed="copyMove",t.$broadcast("ANGULAR_DRAG_START",n,p,b)}else n.preventDefault()}var g,u,c=!1,v=f.draggingClass||"on-dragging";d.attr("draggable",!1),o.$watch(f.uiDraggable,function(e){e?(d.attr("draggable",e),d.bind("dragend",i),d.bind("dragstart",l)):(d.removeAttr("draggable"),d.unbind("dragend",i),d.unbind("dragstart",l))}),e.isString(f.dragHandleClass)&&(c=!0,g=f.dragHandleClass.trim()||"drag-handle",d.bind("mousedown",function(e){u=e.target}))}}]),t.directive("uiOnDrop",["$parse","$rootScope",function(a,t){return function(r,o,d){function f(e){for(var a={x:e.originalEvent.offsetX,y:e.originalEvent.offsetY},n=e.originalEvent.target;n!==o[0];)if(a.x=a.x+n.offsetLeft,a.y=a.y+n.offsetTop,n=n.offsetParent,!n)return null;return a}function i(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation();var n=a(d.uiOnDragOver);return r.$evalAsync(function(){n(r,{$event:e,$channel:p})}),!1}function s(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),v--,0===v&&(r.$evalAsync(function(){D(r,{$event:e,$channel:p})}),o.addClass(m),o.removeClass(h));var n=a(d.uiOnDragLeave);r.$evalAsync(function(){n(r,{$event:e,$channel:p})})}function l(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),0===v&&(r.$evalAsync(function(){y(r,{$event:e,$channel:p})}),o.removeClass(m),o.addClass(h)),v++;var n=a(d.uiOnDragEnter);r.$evalAsync(function(){n(r,{$event:e,$channel:p})}),t.$broadcast("ANGULAR_HOVER",$)}function g(t){t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation();var i=t.dataTransfer.getData("text");i=e.fromJson(i);var s=f(t),l=s?{x:s.x-i.offset.x,y:s.y-i.offset.y}:null;n(t);var g=a(d.uiOnDrop);r.$evalAsync(function(){g(r,{$data:i.data,$event:t,$channel:i.channel,$position:l})}),o.removeClass(m),v=0}function u(e,a){if("*"===a)return!0;var n=new RegExp("(\\s|[,])+("+e+")(\\s|[,])+","i");return n.test(","+a+",")}function c(e){return e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.dataTransfer.dropEffect="none",!1}var v=0,p=d.dropChannel||"defaultchannel",$="",m=d.dragEnterClass||"on-drag-enter",h=d.dragHoverClass||"on-drag-hover",y=a(d.onDragEnter),D=a(d.onDragLeave),b=t.$on("ANGULAR_DRAG_START",function(e,n,t,f){$=t;var v=!0;if(u(t,p)||(v=!1),v&&d.dropValidate){var h=a(d.dropValidate);v=h(r,{$drop:{scope:r,element:o},$event:n,$data:f.data,$channel:f.channel})}v?(o.bind("dragover",i),o.bind("dragenter",l),o.bind("dragleave",s),o.bind("drop",g),o.addClass(m)):(o.bind("dragover",c),o.bind("dragenter",c),o.bind("dragleave",c),o.bind("drop",c),o.removeClass(m))}),A=t.$on("ANGULAR_DRAG_END",function(){o.unbind("dragover",i),o.unbind("dragenter",l),o.unbind("dragleave",s),o.unbind("drop",g),o.removeClass(h),o.removeClass(m),o.unbind("dragover",c),o.unbind("dragenter",c),o.unbind("dragleave",c),o.unbind("drop",c)});r.$on("$destroy",function(){b(),A()}),d.$observe("dropChannel",function(e){e&&(p=e)})}}]),t.constant("$dragImageConfig",{height:20,width:200,padding:10,font:"bold 11px Arial",fontColor:"#eee8d5",backgroundColor:"#93a1a1",xOffset:0,yOffset:0}),t.service("$dragImage",["$dragImageConfig",function(a){function n(e,a,n){var r=e.measureText(a).width;if(r<n.width)return a;for(;r+n.padding>n.width;)a=a.substring(0,a.length-1),r=e.measureText(a+t).width;return a+t}var t="â€¦";this.generate=function(t,r){var o=e.extend({},a,r||{}),d=document.createElement("canvas");d.height=o.height,d.width=o.width;var f=d.getContext("2d");f.fillStyle=o.backgroundColor,f.fillRect(0,0,o.width,o.height),f.font=o.font,f.fillStyle=o.fontColor;var i=n(f,t,o);f.fillText(i,4,o.padding+4);var s=new Image;return s.src=d.toDataURL(),{image:s,xOffset:o.xOffset,yOffset:o.yOffset}}}])}(angular);